---
title: "BRT_SMFS"
author: "Caroline Newell"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries
```{r}
library(dismo)
library(tidyverse)
library(lubridate)
library(caret)
library(sf)
library(readr)

```

# Loading Data
```{r}
SMFS_OTR_Thesis_WithZeros <- read_csv("SMFS_OTR_Thesis_WithZeros.csv")

#Next step: I need a CPUE column. Calculate as catch per minute trawl.
SMFS_OTR_Thesis_WithZeros$CPUE<-SMFS_OTR_Thesis_WithZeros$Count / SMFS_OTR_Thesis_WithZeros$TowDuration

summary(SMFS_OTR_Thesis_WithZeros$CPUE)
```

# TP Practice
```{r}
glimpse(SMFS_OTR_Thesis_WithZeros)
#Lets build a df with just TP data.
TPData<-SMFS_OTR_Thesis_WithZeros %>% filter(OrganismCode == "TP")
#TPData$CPUE<-as.numeric(TPData$CPUE)
glimpse(TPData)
summary(TPData)
```

7,665 trawls in this dataset.
6 NA salinity
60 NA DO
5 NA Water Temp
13 Na Secchi

Need to go back to SMFS_Wrangling to clear this up for whole dataset! 

From here on down, I am following Nima's "caroline_BRTs.rmd" 

```{r}
gbmGrid <- expand.grid(interaction.depth = c(3,5,7), #tree complexity
                       n.trees = 2000, #number of trees
                       shrinkage = 0.1, # or seq(0.01, 0.5, length.out =5) #learning rate
                       #bag.fraction = 0.6, #bag fraction (proportion of observations used in selecting variables) and recommended by Elith
                       n.minobsinnode = 10 # the minimum number of observations in trees' terminal nodes. honestly dont worry about this.
                       )

gbmGrid %>% head() #take a look at what we just made
```

```{r}
fitControl <- trainControl(## 2-fold CV
                           method = "cv",
                           number = 2,
                           classProbs = TRUE, ## Estimate class probabilities
                           summaryFunction = twoClassSummary
                           )
```

Now we can use the `train` function to run the analysis.

I'll start with the most basic dataset for the most basic model: CPUE ~ WaterTemp + Secchi + DO + Salinity

```{r}
set.seed(124) #setting the seed for reproducibility. BRT have randomness in them so if you want to make sure you are getting the same result each time make sure to set the seed

gbmFit <- train(CPUE ~ WaterTemperature + Secchi + DO + Salinity,
                data = TPData, 
                method = "gbm", 
                trControl = fitControl, 
                verbose = FALSE, 
                ## Now specify the exact models 
                ## to evaluate:
                tuneGrid = gbmGrid,
                metric = "ROC" # specifying which metric to choose the optimal parameter values
                )
gbmFit

# we can plot the results too which will be easier to interpret
ggplot(gbmFit)
```

I have missing values! 