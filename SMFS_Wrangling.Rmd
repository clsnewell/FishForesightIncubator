---
title: "SMFS Wrangling"
author: "Caroline Newell"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

In this rmd, I start with the output from SMFSDataTableMerging (SMFS_09192023) to complete the following objectives:

1. Create SMFS_Integrate dataframe by
- Create columns for Year, Month, and Water Year
- Filter to only keep otter trawls and samples after 2010
- Add a column for Organism Code scientific names to match SBOTS (gensp)
- Add age class info
- Add zeros for when fish aren't caught (each species, each size class)
- Save those changes as SMFS_Integrate

2. Create SMFS_OneFishOneRow by taking SMFS_Integrate and giving each fish its own row (aside from plus counted fish)

3. Investigate NA's in the dataset to evaluate the need to interpolate missing environmental data. I create a dataframe of missing environmental data samples called SMFS_NA_WaterQuality and find that there are 46 sampling events with missing wq data. Of these:
> 8 have NA Tow Duration (not real tows)
> 2 from Boynton in July 2013 missing DO and PctSat (BY1, 3)
> 2 from Cutoff in July 2013 missing DO and PctSat (CO1, 2)
> 4 from Denverton (July '13 DV2 NA DO & PctSat; August '13 DV2 NA Secchi; June '12 DV3 NA DO & PctSat; July '13 DV3 NA DO & PctSat)
> 3 from Good Year missing DO & PctSat from July 2013 (GY1,2,3)
> 1 from HL(2) in May 2018 missing Temp, Salinity, DO, PctSat, SpecificCond 
> 1 from Luco (LU1) July 2013 missing DO & PctSat
> 5 from Montezuma slough (MZ1 July 2013 NA DO & PctSat; MZ1 Jan 2015 NA DO & PctSat; MZ2 July 2013 NA DO & PctSat; MZ2 Jan 2015 NA DO & PctSat; MZ6 July 2013 NA DO & PctSat)
> 2 from MZN 3 (July 2013 NA DO & PctSat; Dec 2013 NA Temp, Salinity, DO, PctSat, SpecificCond)
> 3 from Nurse (NS2 July 2013 NA DO & PctSat; NS3 July 2013 NA DO & PctSat; NS3 August 2014 NA Secchi)
> 5 from Peytonia (PT1 August 2022 NA DO & PctSat; PT1 July 2013 NA DO & PctSat; PT2 May 2018 NA Temp, Salinity, DO, PctSat, SpecificCond; PT2 July 2013 NA DO & PctSat; PT2 August 2022NA DO & PctSat)
> 3 from SB (SB1 July '13 NA DO & PctSat; SB2 May 2018 NA Temp, Salinity, DO, PctSat, SpecCond; SB2 July 2013 NA DO & PctSat)
> 1 from Shelldrake (SD2) May 2018 NA Temp, Salinity, DO, PctSat, SpecificCond
> 6 from Suisun (SU1 July 2013 NA DO & PctSat; SU2 July 2013 NA Secchi, DO, PctSat; SU2 August 2013 NA salinity & SpecCond; SU3 July 2013 NA DO & PctSat; SU3 Oct 2013 NA DO & PctSat; SU4 July 2013 NA DO & PctSat)

4. I make an attempt to add zeros and calculate CPUE

# Loading Data
```{r}
#Wrangling SMFS 
library(rlang)
library(readr)
SMFS_09192023 <- read_csv("C:/Users/cnewe/OneDrive/Documents/Incubator/Code/FishForesightIncubator/Data/SMFS_09192023.csv")
str(SMFS_09192023)
library(lubridate)
SMFS_09192023$Year<-year(SMFS_09192023$SampleDate)
SMFS_09192023$Month<-month(SMFS_09192023$SampleDate)
library(lfstat)
library(tidyverse)
SMFS_09192023$WaterYear<-water_year(SMFS_09192023$SampleDate, as.POSIX = FALSE, origin="usgs")
```

# 1. Create SMFS_Integrate dataframe
## Filtering
```{r}
#Now I just want otter trawl data
SMFS_OTR_09192023<-SMFS_09192023 %>% filter(MethodCode %in% "OTR") #filters otter trawl samples from table

#Now I want to constrain the data to the years of interest (2011 to now)
str(SMFS_OTR_09192023)
SMFS_OTR_09192023$WaterYear<-as.character(SMFS_OTR_09192023$WaterYear)#when converting the factor to a number, need to first make it a character and THEN numeric. Otherwise, the number gets changedfor some reason.
SMFS_OTR_09192023$WaterYear<-as.numeric(SMFS_OTR_09192023$WaterYear) #need to make water year numeric so I can filter out years easily.
SMFS_OTR_09192023$Year<-as.numeric(SMFS_OTR_09192023$Year) #need to make water year numeric so I can filter out years easily.

SMFS_Integrate<-SMFS_OTR_09192023 %>% filter(Year > 2010) #Filtering out years which overlap with South Bay Otter Trawl Survey for my thesis work.
```


### Investigating NA's in dataset (Maybe run later)
```{r}
#How many rows will we lose if we remove NAs?
sum(is.na(SMFS_Integrate$WaterTemperature)) #44
sum(is.na(SMFS_Integrate$DO)) #495
sum(is.na(SMFS_Integrate$Salinity)) #47
sum(is.na(SMFS_Integrate$Secchi)) #100
#This isn't super helpful... We have multiple rows for one 
Na_Assessment<-SMFS_Integrate %>% 
  group_by(SampleRowID) %>% 
  dplyr::summarize(WaterTemp_NA=sum(is.na(WaterTemperature)),
            DO_NA =  sum(is.na(DO)),
            Sal_NA = sum(is.na(Salinity)),
            Secchi_NA=sum(is.na(Secchi)))
Na_Assessment<- Na_Assessment %>% filter(WaterTemp_NA>0 | DO_NA>0 | Sal_NA>0 | Secchi_NA>0)
#Overall, there are 46 sampling events with missing wq data.
#let's find out more about these.
NaSamples<-Na_Assessment$SampleRowID

SMFS_OTR_Thesis_WQNA<-SMFS_Integrate %>% filter(SampleRowID %in% NaSamples) %>% group_by(SampleRowID) %>% dplyr::select(SampleRowID, StationCode, MethodCode, TowDuration, WaterTemperature, Secchi, Salinity, DO, PctSaturation, SpecificConductance, TideCode, SampleDate, Year, WaterYear)
SMFS_OTR_Thesis_WQNA<-as.data.frame(SMFS_OTR_Thesis_WQNA)
SMFS_OTR_Thesis_WQNA<-SMFS_OTR_Thesis_WQNA %>% distinct()
#Save New DF
#write.csv(SMFS_OTR_Thesis_WQNA, "C:/Users/cnewe/OneDrive/Documents/Incubator/Code/FishForesightIncubator/Data/SMFS_NA_WaterQuality.csv") #This holds the information with samples that have NA wq data


#Visualizing fish counts by year for each species
FishCountTable<-SMFS_Integrate %>% group_by(OrganismCode) %>% summarise(Total=sum(Count))

FishCountTable<-SMFS_Integrate %>% group_by(OrganismCode, Year) %>% summarise(Total=sum(Count))

FishCountTable %>% spread(key = Year, value = Total)

#Adding zeros for sampling events with no fish caught
#https://derekogle.com/fishR/2018-04-19-Adding-Zero-Catches
length(unique(SMFS_Integrate$SampleRowID)) 
length(unique(SMFS_Integrate$TrawlRowID)) 
length(unique(SMFS_Integrate$OrganismCode))
3702*79


Nas_<-SMFS_Integrate %>% filter(TowDuration %in% NA)
NA_SampleRowIDs<-unique(Nas_$SampleRowID)
NA_Tow_Info<-SMFS_09192023 %>% filter(SampleRowID %in% NA_SampleRowIDs)
unique(NA_Tow_Info$SampleRowID)
#Okay I am deducing that these samples are actually fake samples with incidental or rod and reel info? 
#Removing all NA Trawl Duration (below)


#Why NA DO?
NoDO<-SMFS_Integrate %>% filter(DO %in% NA)
#Reasons for missing DO: 
#Row 81, 232, 253,  - just didn't record DO or PctSat
#Is it missing for other organisms from the same trawl?

NoDOTrawlID<-unique(NoDO$TrawlRowID)
length(NoDOTrawlID) #35 trawls
NoDOTrawls<-SMFS_Integrate %>% filter(TrawlRowID %in% NoDOTrawlID) #nope. The trawl just doesn't have the info! Remove these rows.


#Now checking salinity
NoSal<-SMFS_Integrate %>% filter(Salinity %in% NA)
NoSalTrawlID<-unique(NoSal$TrawlRowID)
length(NoSalTrawlID) #6 trawls
NoSalTrawls<-SMFS_Integrate %>% filter(TrawlRowID %in% NoSalTrawlID) #These trawls just doesn't have the info! Remove these rows.

#Now checking Secchi
NoSecchi<-SMFS_Integrate %>% filter(Secchi %in% NA)
NoSecchiTrawlID<-unique(NoSecchi$TrawlRowID) 
length(NoSecchiTrawlID) #3 trawls
NoSecchiTrawls<-SMFS_Integrate %>% filter(TrawlRowID %in% NoSecchiTrawlID) #These trawls just doesn't have the info! Remove these rows.

#Now checking Water Temp
NoWT<-SMFS_Integrate %>% filter(WaterTemperature %in% NA)
NoWTTrawlID<-unique(NoWT$TrawlRowID) 
length(NoWTTrawlID) #5 trawls
NoWTTrawls<-SMFS_Integrate %>% filter(TrawlRowID %in% NoWTTrawlID) #These trawls just doesn't have the info! Also missing all other WQ. Remove these rows.
#I remove these NAs in the SMFS_WranglingForThesis rmd
```

## Adding species name information

```{r}

library(readxl)
SMFS_OrganismsLookUp <- read_excel("Data/SMFS_OrganismsLookUp.xlsx")

SMFS_Integrate<-left_join(SMFS_Integrate, SMFS_OrganismsLookUp, by = "OrganismCode")

SMFS_Integrate<-mutate(SMFS_Integrate, gensp = paste(Genus, Species, sep=" "))
#Many rows of NA NA for gensp.
na_gensp_rows <- subset(SMFS_Integrate, gensp == "NA NA")
unique(na_gensp_rows$CommonName)
na_gensp <-na_gensp_rows %>% group_by(CommonName) %>% summarise(nrows= n(), CountTotal = sum(Count)) #unknown fish IDs. Remove. Losing "Goby Unknown"        "Herring Unknown"     "Unknown Larval Fish" "Heel Splitter"  "Catfish Unknown"     "Water quality only"
SMFS_Integrate<-SMFS_Integrate %>% filter(!gensp == "NA NA")
```


## Adding Age Class Info
```{r}
#Need to merge with ages. Will move this to data wrangling after plus counts are dealt with.
SMFS_AgesBySizeMo <- read_excel("Data/SMFS_AgesBySizeMo.xlsx")
#Need to update the max in the csv for sizes for HCH to 266 in Jan, BF to 450 in Oct, and ASH to 460 in Aug
SMFS_AgesBySizeMo<-SMFS_AgesBySizeMo %>% mutate(Max = case_when(OrganismCode == "HCH" & Month == 1 ~ 267,
                          OrganismCode == "BF" & Month == 10  ~ 451,
                          OrganismCode == "ASH" & Class == "Age-1+" & Month == 8  ~ 461, TRUE~Max)) #The code above increases the maxes for the 3 fish previously being deleted because the SMFS_AgesBySizeMo does not have ranges that capture them.

#ggplot(SMFS_AgesBySizeMo, aes(x=Month, color=Class))+
 # geom_linerange(ymin=SMFS_AgesBySizeMo$Min, ymax=SMFS_AgesBySizeMo$Max)+
 # facet_wrap(~OrganismCode) #I want to double check these are right with no overlap by plotting them but it is hard :(

#If a fish is given no age class I want to assign NA to them
unique(SMFS_AgesBySizeMo$OrganismCode) #33 species
unique(SMFS_Integrate$OrganismCode) #77 including non-fish
SMFS_Integrate_t<- SMFS_Integrate %>% 
  dplyr::filter(Class %in% c("Osteichthyes","Cephalaspidomorphi")) 
unique(SMFS_Integrate_t$OrganismCode) #48 fishes. 

#Okay so for the 15 fishes left out I need to add them to the SMFS_AgesBySizeMo dataframe?



#Filtering out just fish that we have age class info for...
AgedFish<-SMFS_Integrate %>% filter(OrganismCode%in%c("LFS", "SB", "TP", "STAG", "SF", "CP", "DS", "ISS", "WCF", "TFS", "ST", "STBK", "SCP", "SKR", "BF", "BLB", "CCF", "CS", "HCH", "MQF", "NAC", "PH", "RWK", "SPM", "WAK", "WC", "WS", "YFG", "ASH", "SG", "SKG", "BC", "GF")) 

#filter out instances where there is 0 standard length, I'll rbind them back later.
PlusCounts<-AgedFish %>% filter(StandardLength==0)
SummPlusCounts<-PlusCounts %>% dplyr::group_by(CommonName) %>% dplyr::summarize(nrows= n(), CountTotal = sum(Count))

AgedFish_AgeClass<-AgedFish %>% filter(StandardLength!=0)

#before I add age class, I have to rename a duplicated column name "class"
AgesBySizeMo<-SMFS_AgesBySizeMo %>% rename("AgeClass"="Class")
#adding age class info
AgedFish_Class<- left_join(AgedFish_AgeClass, AgesBySizeMo, join_by("OrganismCode", "Month"))#left join because I don't want age classes for fish we did not catch.
glimpse(AgedFish_Class) #148,341 rows, 52 columns.

# Create a boolean condition based on the size range
condition <- between(AgedFish_Class$StandardLength, AgedFish_Class$Min, AgedFish_Class$Max)

# Update the 'Class' column in 'AgedFish_Class'
AgedFish_Class$AgeClass <- ifelse(condition, AgedFish_Class$AgeClass, "Delete") #Keeping age class assignments if condition is met, otherwise assigning "delete" value to the row.
unique(AgedFish_Class$AgeClass)

AgedFish_Class <- filter(AgedFish_Class, AgeClass != "Delete") #deleting the rows that did not match the condition
unique(AgedFish_Class$AgeClass)
glimpse(AgedFish_Class) #58,320 rows


#Now adding plus counts back in
PlusCounts<-PlusCounts %>% mutate(Min = NA, Max = NA, AgeClass = "PLUS")
AgedFish_AgeClasses<-rbind(AgedFish_Class, PlusCounts)

glimpse(AgedFish) #58,638 rows and 50 columns before adding age class information. Number of rows should match AgedFish_AgeClasses output.

glimpse(AgedFish_Class)#58,313 rows after removing plus counts (length of 0).

glimpse(AgesBySizeMo) #663 rows (should be 149,168 rows and 52 columns?) after removing plus counts and joining data with age classes. I get every possible age class here for each fish.

glimpse(PlusCounts)#325 rows and 52 columns of plus counts.

glimpse(AgedFish_AgeClasses) #58,638 rows and 53 columns of measured fish with plus count fish.

#Now need to add back in the species we lost when making AgedFish. They matter too.
BringEmBack<-SMFS_Integrate %>% filter(!OrganismCode %in% c("LFS", "SB", "TP", "STAG", "SF", "CP", "DS", "ISS", "WCF", "TFS", "ST", "STBK", "SCP", "SKR", "BF", "BLB", "CCF", "CS", "HCH", "MQF", "NAC", "PH", "RWK", "SPM", "WAK", "WC", "WS", "YFG", "ASH", "SG", "SKG", "BC", "GF")) %>% mutate(Max = NA, Min = NA, AgeClass = "N/A")

DataWithAges<-rbind(AgedFish_AgeClasses, BringEmBack) #80063 rows, 53 columns. Back to the start! Bon.
unique(DataWithAges$OrganismCode) #77 fish (and non-fish)
#Do I have instances of catching only large fish not well sampled?
Inquiry<- DataWithAges %>% filter(gensp %in% c("Alosa sapidissima", "Spirinchus thaleichthys", "Cottus asper", "Gasterosteus aculeatus", "Menidia beryllina", "Tridentiger barbatus"))

AgeTable<-Inquiry %>% group_by(gensp, AgeClass) %>% dplyr::summarise(CountSum = sum(Count))
```

Plus counts unaltered but may want to update them so that I can create a filter to remove non-targeted fish sizes.

For presence/absence model, filter on tows that measured big fish. Remove those fish/observations. And then for all tows, label each tow as 'presence' or 'absent'. If there was a tow that only measured big fish, it will look like no fish were captured because you removed all instances of big fish measurements. This avoids dealing with plus count, which we don't need for the presence/absent model. I

### Fixing plus counts -DONT RUN
```{r}
unique(DataWithAges$CatchComments) # I thought there were catch comments before that detailed what size the plus counted fish were.
#Attempt lives in SMFS_AgeClassIncorporation. Proportional assignment of plus counts my idea. Lewis proposes creating a distribution of sizes and then sampling randomly from that which would be better in cases of plus counts being low. But I'll move forward with my own attempt to fix plus counts.

# Step 1: Filter rows where Class is not "NA_Class" and Counted is greater than 0
df_filtered <- DataWithAges %>%
  filter(!is.na(Class), Class != "NA_Class", Counted > 0)

# Step 2: Calculate the total count for each SampleRowID and OrganismCode
df_total_counts <- df_filtered %>%
  group_by(SampleRowID, OrganismCode) %>%
  summarize(TotalCount = sum(Counted), .groups = "drop")

# Step 3: Calculate the proportion for each age class
df_proportions <- df_Class_NA %>%
  left_join(df_total_counts, by = c("SampleRowID", "OrganismCode")) %>%
  mutate(
    Proportion = ifelse(
      Class != "NA_Class",
      Counted / TotalCount,
      0
    )
  )

# Step 4: Calculate the total "NA" counts for each SampleRowID
df_na_counts <- df_proportions %>%
  filter(is.na(Class)) %>%
  group_by(SampleRowID) %>%
  summarize(NA_Count = sum(Counted), .groups = "drop")

# Step 5: Distribute the "NA" counts proportionally to other age classes
df_final <- df_proportions %>%
  left_join(df_na_counts, by = "SampleRowID") %>%
  mutate(
    Counted = ifelse(
      !is.na(Class),
      round(Counted + Proportion * NA_Count),
      0
    )
  ) %>%
  select(-TotalCount, -Proportion, -NA_Count)
```





### One fish one row (MUST RUN)
I assume we don't want 1 row, 1 fish for all of the unmeasured fish and would instead prefer 1 row 1 fish for all of the measured fish, and all of the unmeasured fish together in a row to later be expanded once we decide on a method for doing that. Otherwise, I can easily change the code to uncount everything by removing the filter.
```{r}
SMFS_Integrate_Expand <- SMFS_Integrate %>%
  filter(StandardLength > 0) %>% #only keeping measured fish
  uncount(Count, .remove = FALSE) #keeps number of rows that corresponds to the Count value
SMFS_Integrate_Expand$Count<-1 #assigns value of 1

PlusCountDF<-SMFS_Integrate %>%
  filter(!StandardLength > 0)
SMFS_Integrate_Expand2<-rbind(SMFS_Integrate_Expand, PlusCountDF)

#Save New DF
#write.csv(SMFS_Integrate_Expand2, "C:/Users/cnewe/OneDrive/Documents/Incubator/Code/FishForesightIncubator/Data/SMFS_OneFishOneRow.csv")

PlusTable<-PlusCountDF %>% filter(OrganismCode %in% c("ASH", "SKG", "ISS", "STBK", "LFS", "SCP")) %>% group_by(OrganismCode) %>% dplyr::summarise(CountSum = sum(Count))


```



### Adding zeros, calculating cpue (dead code)
```{r}
#Now we add zeros! For every sampling event (unique sample row ID) there should be catch data for each species (unique organism code). 

#SMFS_OTR_Thesis_WithZeros<-SMFS_OTR_Thesis %>% 
 # complete(nesting(SampleRowID, 
  #                 WaterTemperature, 
  #                 Secchi, 
  #                 DO, 
  #                 Salinity, 
  #                 MethodCode, 
  #                 StationCode, 
  #                 SampleDate, 
  #                 SampleTime, 
  #                 PctSaturation, 
  #                 SpecificConductance, 
   #                TideCode, 
   #                ElecCond, 
   #                TowDuration, 
  #                 TrawlComments, 
   #                Year, 
  #                 WaterYear), 
   #        OrganismCode, 
   #        fill=list(num=0)) %>% as.data.frame() #Didn't add 0 values...Also ended up with more rows than expected? I have more rows than expected because there are multiple SIZES which each get their own row as well. So if I care about size/age classes, will have to bin those first and then add zeros. For now, move forward here.

#SMFS_OTR_Thesis_WithZeros$Count[is.na(SMFS_OTR_Thesis_WithZeros$Count)] <- 0
#NOW it has zeros

#Check to see if it worked by counting number of rows for each sampling event (unique tow ID) and make sure it has a minimum of 79 accounts (79 unique organism codes in SMFS_OTR_Thesis)
#Check<-SMFS_OTR_Thesis_WithZeros %>% group_by(SampleDate, StationCode) %>% summarize(n=n())
#unique(Check$n) #We have 3693 trawls! We have at least 79 accounts per trawl (but that also doesn't make sense if we have at least one row with non-zero counts yeah?)
#How to check that we didn't make up trawls?
#CheckCheck<- SMFS_OTR_Thesis %>% group_by(SampleDate, StationCode) %>% summarize(n=n()) #Same number of rows so that is good.

#you can also use spread(..... fill = 0) to add zeros to every sample x spp combo that doesn't exist or have data and then gather() it back up.

#Now I want to look at fish and their frequencies of catch over water quality parameters. 

#which(is.na(SMFS_OTR_Thesis$WaterTemperature)) #THIS IS A PROBLEM (for later). Use this link to fix: https://www.tutorialspoint.com/dealing-with-missing-data-in-r#:~:text=Finding%20Missing%20Data%20in%20R&text=We%20can%20use%20the%20is,otherwise%20it%20should%20be%20False.

#adding month real quick
#SMFS_OTR_Thesis_WithZeros$Month<-month(SMFS_OTR_Thesis_WithZeros$SampleDate)

#Tester<-SMFS_OTR_Thesis[SMFS_OTR_Thesis$SampleRowID %in% "{E4889AE1-DD10-4A96-A1C2-E0BFFEB6FCBF}",]
#Tester2<-SMFS_OTR_Thesis_WithZeros[SMFS_OTR_Thesis_WithZeros$SampleRowID %in% "{E4889AE1-DD10-4A96-A1C2-E0BFFEB6FCBF}",]

#SMFS_OTR_Thesis_WithZeros$CPUE<-SMFS_OTR_Thesis_WithZeros$Count / SMFS_OTR_Thesis_WithZeros$TowDuration

#summary(SMFS_OTR_Thesis_WithZeros)

#Matching fish names
#library(readxl)
#SMFS_OrganismsLookUp <- read_excel("Data/SMFS_OrganismsLookUp.xlsx")

#SMFS<-left_join(SMFS_OTR_Thesis_WithZeros, SMFS_OrganismsLookUp, by = "OrganismCode")

#SMFS<-mutate(SMFS, gensp = paste(Genus, Species, sep=" "))


#Save New DF
#write.csv(SMFS, "C:/Users/cnewe/OneDrive/Documents/Incubator/Code/FishForesightIncubator/Data/SMFS_Zeros.csv")
```


## Plus Count Expansion
Trawls have a range of measured fish for plus counts. Some of these have a wide range (one 625mm fish and the rest under 200mm for example). 
1. Pull from comments. Or use the comments to ground-truth.
2.Identify and remove outliers from trawls when doing this calculation.
3. Either random assignment or proportional (Levi doing random). Poisson distribution? 
4. Give each fish own row and ID.  

Built with Levi and Kyle.
### Trying to remove outliers then random sample from normal distribution. [DO NOT RUN]
```{r}
#Doesn't work well with non-fish. Let's isolate the fish and then run the code. 
PlusCountDF<-PlusCountDF %>% filter(Class %in% c("Osteichthyes","Cephalaspidomorphi")) #bring back the others later: "Malacostraca" "Crustacea"    "Bivalvia"    [4] "many"         "Hydrozoa"     "N/A"   "Insecta"      "Angiosperms" [10] "NA"    
unique(PlusCountDF$OrganismCode)


#Remove outliers (temporarily)
#out<-boxplot.stats(dat$hwy)$out
#outliers_ind<-which(dat$hwy %in% c(out))
#out<-SMFS_Integrate_Expand %>%
#  dplyr::group_by(SampleRowID, gensp) %>%
#  dplyr::summarize(outliers = list(boxplot.stats(StandardLength)$out)) %>% filter(!outliers %in% "numeric(0)") %>% tidyr::unnest(outliers)  #3060 outliers identified. 
#out$StandardLength<-out$outliers
  
#result <- dplyr::right_join(SMFS_Integrate_Expand, out, join_by(SampleRowID, gensp, StandardLength)) #3236

#now I want to isolate rows where the outlier == standard length
#result %>% ifelse(StandardLength == outliers,  )

# Suppose we want to create a new column indicating whether the StandardLength is an outlier

#OutlierList<-result$CatchRowID

#SMFS_Integrate_Expanded_OutliersRemoved<-SMFS_Integrate_Expand %>% filter(CatchRowID %in% OutlierList)

#prep_exp_table <- 
  # lengths_df  %>%                       # formatted raw catch data
#  SMFS_Integrate_Expand %>%
#  group_by(SampleRowID,gensp) %>%                 # group x taxon & tow 
#  dplyr::summarize(m_sl = mean(StandardLength, na.rm=T),            # generate mean sl (for rnorm expansion)
#            sd_sl = sd(StandardLength, na.rm=T),             # generate sd (for rnorm expansion)
#            n_sl = length(StandardLength)) %>%      # generate n of length measurements (as a check)
#  full_join(PlusCountDF, c("SampleRowID", "gensp")) %>%  # join with plus counts (number of lengths that require expansion x tow x spp)
#  filter(StandardLength == 0, Count != 0) %>%    #LOOK INTO WHY 0 COUNT!!!               # keep only the plus count data (remove length data)
#  mutate(sd_sl = if_else(Count==1, 0.2*m_sl, sd_sl)) %>%  # if only 1 length value, assume sd = 0.2*SL (if no lengths, then expanded lengths will be NA).
#  dplyr::select(SampleRowID, gensp, m_sl, sd_sl, n_sl, StandardLength, Count) %>% 
#  data.frame 

#Zscoreprep<-prep_exp_table %>% dplyr::select(SampleRowID, gensp, m_sl, sd_sl, n_sl)

#Zscoredf<-right_join(SMFS_Integrate_Expand, Zscoreprep) #only keep rows with plus counts
#Zscoredf$z<-(Zscoredf$StandardLength - Zscoredf$m_sl)/Zscoredf$sd_sl #greater than 3.5 is outlier. Can also check the out table produced by chat.gpt code

#OutZ<-Zscoredf %>% filter(z > 0.5 | z < -0.5)

#106 fish are outliers according to this z score... Way less than what was identified by above out code.

#Try to be conservative. For now, remove the z score fish and then run the plus count expansion, look for negative values and compare to comments. If not, then change threshold.

#After trying 3.5 threshold still resulting in values assigned to plus counts below 10 mm. 

#thanks Kyle!!


#OutZList<-unique(OutZ$CatchRowID)

#SMFS_Integrate_Expanded_OutliersRemoved<-SMFS_Integrate_Expand %>% filter(!CatchRowID %in% OutZList) #removing outliers from plus count expansion 

exp_table <- 
  # lengths_df  %>%                       # formatted raw catch data
  SMFS_Integrate_Expand %>%
  group_by(SampleRowID,gensp) %>%                 # group x taxon & tow 
  dplyr::summarize(m_sl = mean(StandardLength, na.rm=T),            # generate mean sl (for rnorm expansion)
            sd_sl = sd(StandardLength, na.rm=T),             # generate sd (for rnorm expansion)
            n_sl = length(StandardLength)) %>%      # generate n of length measurements (as a check)
  full_join(PlusCountDF, c("SampleRowID", "gensp")) %>%  # join with plus counts (number of lengths that require expansion x tow x spp)
  filter(StandardLength == 0, Count != 0) %>%    #LOOK INTO WHY 0 COUNT!!!               # keep only the plus count data (remove length data)
  mutate(sd_sl = if_else(Count==1, 0.2*m_sl, sd_sl)) %>%  # if only 1 length value, assume sd = 0.2*SL (if no lengths, then expanded lengths will be NA).
  dplyr::select(SampleRowID, gensp, m_sl, sd_sl, n_sl, StandardLength, Count) %>% 
  data.frame 
# generate unique "sp_id" vector for looping
#exp_table should only have 8 columns: tow id, code, 
exp_table$id_sp <- paste0(exp_table$SampleRowID, "_", exp_table$gensp) 
id_sp <- unique(exp_table$id_sp)
id_sp
# ...expanded lengths list/table ----
exp_table$id_sp
exp_sl_list <- list()   # establish empty expanded lengths list
for(i in id_sp){        # add expanded lengths to list
  # i = id_sp[1]
  temp <- exp_table %>% filter(id_sp ==i)
  set.seed(1)
  df <- data.frame(
    SampleRowID = rep(temp$SampleRowID, temp$Count), #update with column names.
    gensp =  rep(temp$gensp, temp$Count),
    Count = rep(1, temp$Count),
    sl = round(rpois(temp$Count, temp$m_sl)),
    type = "length_plus")
  df_list <- list(df)  # convert to list element
  names(df_list) <- i  # name list element based on id_sp value
  exp_sl_list <- append(exp_sl_list, df_list) # add new element to master list
}
exp_sl_list 

#Okay, now take those lengths and assign them to fish in the SMFS dataset.

#First make this list something I can work with by turning it into a dataframe.

PlusAssigned<-do.call(rbind.data.frame, exp_sl_list) #creates a dataframe from the list (though strange identifier for rows). 

#Showing negative values for sl! All the same ID... Flag these negative values...
negative_sl_rows <- PlusAssigned %>% filter(sl<0) #311 with nothing removed. 135 after threshold of 3.5 set and outliers removed. 112 after threshold of 3 set and outliers removed. 50 after threshold of 2.39 after 1.5 threshold set. 35 after 1 set. 567 after 0.5 set. 78 after 0.5 threshold set.

#141 outliers below 5 after removing all outliers identified with boxplot method. 113 below 0. 
#I AM STUCK.



#conclusion: z-scores not useful for removing outliers. 
Unique_slrows<-as.list(unique(negative_sl_rows$SampleRowID))
Collapsed_Negatives<-negative_sl_rows %>% select(SampleRowID, gensp) %>% distinct()
```

### Proportional assignments by age class to plus counts
```{r}

SMFS_Integrate_ExpandAge <- DataWithAges %>%
  filter(StandardLength > 0) %>% #only keeping measured fish
  uncount(Count, .remove = FALSE) #keeps number of rows that corresponds to the Count value
SMFS_Integrate_ExpandAge$Count<-1 #assigns value of 1

PlusCountDFAge<-DataWithAges %>%
  filter(!StandardLength > 0)
SMFS_Integrate_Expand2<-rbind(SMFS_Integrate_ExpandAge, PlusCountDFAge)

PlusCountDFFishAge<-PlusCountDFAge %>% filter(Class %in% c("Osteichthyes","Cephalaspidomorphi"))# %>% 
  #uncount(Count, .remove = FALSE)
#PlusCountDFFishAge$Count<-1 #assigns value of 1

#bring back the others later: "Malacostraca" "Crustacea"    "Bivalvia"    [4] "many"         "Hydrozoa"     "N/A"   "Insecta"      "Angiosperms" [10] "NA"    
unique(SMFS_Integrate_ExpandAge$AgeClass)

exp_table <- 
  # lengths_df  %>%                       # formatted raw catch data
  SMFS_Integrate_ExpandAge %>%
  mutate(Age0=ifelse(AgeClass == "Age-0", 1, 0), Age1 = ifelse(AgeClass == "Age-1", 1, 0), Age1Plus = ifelse(AgeClass == "Age-1+", 1, 0), Age2Plus = ifelse(AgeClass == "Age-2+", 1, 0), NAClass = ifelse(AgeClass == "N/A", 1, 0)) %>% 
  group_by(SampleRowID,gensp) %>%                 # group x taxon & tow 
  dplyr::summarize(Age0Sum = sum(Age0), Age1Sum = sum(Age1), Age1PlusSum = sum(Age1Plus), Age2PlusSum = sum(Age2Plus), NASum=sum(NAClass), TotalMeasured = n()) %>%      # generate n of length measurements (as a check)
  dplyr::right_join(PlusCountDFFishAge, c("SampleRowID", "gensp")) %>%  # join with plus counts (number of lengths that require expansion x tow x spp)
  #filter(AgeClass == "PLUS") %>%    #LOOK INTO WHY 0 COUNT!!!               # keep only the plus count data (remove length data)
    dplyr::select(SampleRowID, gensp, Age0Sum, Age1Sum, Age1PlusSum, Age2PlusSum, NASum, TotalMeasured, Count) %>% 
  data.frame 
# generate unique "sp_id" vector for looping
#exp_table should only have 8 columns: tow id, code, 
exp_table$id_sp <- paste0(exp_table$SampleRowID, "_", exp_table$gensp)  #Gives each sampling event and species combo a unique ID

#Which samples_ids have comments providing info on sizes?
DataWithAges$id_sp <- paste0(DataWithAges$SampleRowID, "_", DataWithAges$gensp) 
unique(DataWithAges$CatchComments)
AllYOY<-DataWithAges %>% filter(CatchComments%in%c("YOY <40 mm SL", "YOY", "young of year", "yoy","all YOY (<30  mm)","all YOY (<40 mm SL)","all YOY (<40 mmSL)", "all YOY (<35 mm)", "YOY-sized fish (~45 mm SL)", "age 0","all young of year", "YOY (<135 mm SL)", "YOY (<40 mm SL)","YOY (<50 mm SL)", "age 0 (<40 mmm)", "YOY (<30 mm)", "(YOY - all less than 100 mm SL)", "age-o fish (<30 mm SL)", "young of year;young of year", "YOY (<60 mm SL)", "age-0 fish","YOY (<50 mmSL)", "all YOY (<100 mm SL)", "all YOY"))
YoyList<-AllYOY$id_sp

#DKS
t <- exp_table %>%
  mutate(age_0_plusct = round((Age0Sum/TotalMeasured)*Count,0),
         age_1_plusct = round((Age1Sum/TotalMeasured)*Count,0),
         age_1plus_plusct = round((Age1PlusSum/TotalMeasured)*Count,0),
         age_2_plusct = round((Age2PlusSum/TotalMeasured)*Count),0,
         NA_plusct = round((NASum/TotalMeasured)*Count),0)
#Check if there are any missing plus counts from this rounding method
t$check<-t$age_0_plusct+t$age_1_plusct+t$age_1plus_plusct+t$age_2_plusct+t$NA_plusct
t$Good<-ifelse(t$Count == t$check, TRUE, FALSE)
Wrong<-t %>% filter(Good == FALSE)
Wrong$Difference<-Wrong$check-Wrong$Count #10 of 327 sampling events were off by 1 fish (lost or gained due to math of proportional rounding)

#I can fix some of them by using the catch comments. Should I go through and fix the catch comments anyways for the most honest accounting? Or only use it to see how many fish were incorrectly assigned using this technique? For instance in {4B89C4D9-80A9-4797-8F71-6D78DB31981E} for SB should all be YOY but only 178/191 are. Ask Mikaela.

#Okay, now take those age classes and assign them to fish in the SMFS dataset.

#Step 1: Get structure of t to match SMFS_Integrate_Expand. 1 row = 1 fish 
View(DataWithAges)
#Step 2: Add the rows to 

```
357 plus counts given lengths. how many were there before?

### Adding zeros - LAST STEP
```{r}
#Now add zeros!
SMFS_OTR_Thesis_AgeClassWithZeros<-DataWithAges %>% 
  complete(nesting(SampleRowID, 
                   WaterTemperature, 
                   Secchi, 
                   DO, 
                   Salinity, 
                   MethodCode, 
                   StationCode, 
                   SampleDate, 
                   SampleTime, 
                   PctSaturation, 
                   SpecificConductance, 
                   TideCode, 
                   ElecCond, 
                   TowDuration, 
                   TrawlComments, 
                   Year,
                   Month,
                   WaterYear), 
           OrganismCode, AgeClass,
           fill=list(num=0)) %>% as.data.frame() #Didn't add 0 values...Also ended up with more rows than expected? I have more rows than expected because there are multiple SIZES which each get their own row as well. So if I care about size/age classes, will have to bin those first and then add zeros. For now, move forward here.

SMFS_OTR_Thesis_AgeClassWithZeros$Count[is.na(SMFS_OTR_Thesis_AgeClassWithZeros$Count)] <- 0
#NOW it has zeros
```

# Save
```{r}
#Save New DF
#write.csv(SMFS_Integrate, "C:/Users/cnewe/OneDrive/Documents/Incubator/Code/FishForesightIncubator/Data/SMFS_Integrate.csv")

```