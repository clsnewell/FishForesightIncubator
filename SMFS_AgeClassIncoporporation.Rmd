---
title: "AgeClass"
author: "Caroline Newell"
date: "`r Sys.Date()`"
output: word_document
---
```{r}
library(fuzzyjoin)
library(tidyverse)
library(rlang)
library(cowplot)
library(readr)
SMFS_05202023 <- read_csv("Data/SMFS_05202023.csv")
str(SMFS_05202023)
library(lubridate)
SMFS_05202023$Year<-year(SMFS_05202023$SampleDate)
SMFS_05202023$Month<-month(SMFS_05202023$SampleDate)
library(lfstat)
SMFS_05202023$WaterYear<-water_year(SMFS_05202023$SampleDate, as.POSIX = FALSE, origin="usgs")

#Now I just want otter trawl data
SMFS_OTR_05202023<-SMFS_05202023 %>% filter(MethodCode %in% "OTR") #filters otter trawl samples from table

#Now I want to constrain the data to the years of interest (2011 to now)
str(SMFS_OTR_05202023)
SMFS_OTR_05202023$WaterYear<-as.character(SMFS_OTR_05202023$WaterYear)#when converting the factor to a number, need to first make it a character and THEN numeric. Otherwise, the number gets changedfor some reason.
SMFS_OTR_05202023$WaterYear<-as.numeric(SMFS_OTR_05202023$WaterYear) #need to make water year numeric so I can filter out years easily.
SMFS_OTR_Thesis<-SMFS_OTR_05202023 %>% filter(WaterYear > 2010) #Filtering out water years which overlap with South Bay Otter Trawl Survey for my thesis work.
library(readxl)
SMFS_AgesBySizeMo <- read_excel("Data/SMFS_AgesBySizeMo.xlsx")


# Perform a conditional left join based on range conditions
merged_data <- fuzzy_left_join(SMFS_OTR_Thesis, SMFS_AgesBySizeMo, 
                               by = c("OrganismCode" = "OrganismCode",
                                      "StandardLength" = "Min", "StandardLength" = "Max", "Month"),
                               match_fun = list(`==`, `>=`, `<=`, `==`))
#It worked! 

# Select the desired columns and remove duplicates
#merged_data <- merged_data %>%
 # select(-Month.x, -Min.x, -Max.x) %>%
  #rename(Class = Class.y)
# Remove duplicate Month column from SMFS_AgesBySizeMo
merged_data <- merged_data %>% rename(Month=Month.x)
merged_data <- merged_data %>% rename(OrganismCode=OrganismCode.x)

# Check the resulting dataframe
#glimpse(merged_data)

#Now add zeros!
SMFS_OTR_Thesis_AgeClassWithZeros<-merged_data %>% 
  complete(nesting(SampleRowID, 
                   WaterTemperature, 
                   Secchi, 
                   DO, 
                   Salinity, 
                   MethodCode, 
                   StationCode, 
                   SampleDate, 
                   SampleTime, 
                   PctSaturation, 
                   SpecificConductance, 
                   TideCode, 
                   ElecCond, 
                   TowDuration, 
                   TrawlComments, 
                   Year,
                   Month,
                   WaterYear), 
           OrganismCode, Class,
           fill=list(num=0)) %>% as.data.frame() #Didn't add 0 values...Also ended up with more rows than expected? I have more rows than expected because there are multiple SIZES which each get their own row as well. So if I care about size/age classes, will have to bin those first and then add zeros. For now, move forward here.

SMFS_OTR_Thesis_AgeClassWithZeros$Count[is.na(SMFS_OTR_Thesis_AgeClassWithZeros$Count)] <- 0
#NOW it has zeros
```

# Now Plot For each age class for each species of interest
```{r}
#First, what are the age classes for each species?
ClassCountTable<-SMFS_OTR_Thesis_AgeClassWithZeros %>% group_by(OrganismCode, Class) %>% summarise(Total=sum(Count))
# Filter rows with the specified 'FishOfInterest'
filtered_data <- SMFS_OTR_Thesis_AgeClassWithZeros %>%
  filter(OrganismCode %in% FishOfInterest)

# Count the number of distinct 'SampleRowID' values in the filtered data
n_distinct(filtered_data$SampleRowID)

```

ASH: 1027 Age 0, 0 Age 1, 296 Age 1+, 0 Age 2+
ISS: no age class info: 929 + 328
SB: 10534 Age 0, 4069 Age 1, 0 Age 1+, 975 Age 2+, 5082 NA
Shoot, there are a bunch of plus counted fish in here.
I want to incorporate them. 

#Lets see how many fish have no standard length associated with them.
```{r}
FishOfInterest<- c("SB", "ASH", "TFS", "ISS", "SCP", "SF", "TP", "LFS", "YFG")

NoSL<-SMFS_OTR_Thesis %>% filter(StandardLength == 0, OrganismCode %in% FishOfInterest)
n_distinct(NoSL$TrawlRowID)
TotalNoSL<-NoSL %>% summarise(Total=sum(Count)) #Total number of plus counted fish in dataset = 6984
WithSL<-SMFS_OTR_Thesis %>% filter(!StandardLength == 0, OrganismCode %in% FishOfInterest) %>% summarise(Total=sum(Count)) #Total number of fish with length data = 34641
#Total number of fish in dataset = 41,625
#16% of the data is plus count!!!
```

Be careful to not assign lengths to fish that were plus counted because they escaped. There should be some sort of rule where we only assign sizes if there were over 30 of a species in the trawl.
Also, some of the entries have comments indicating the size of the fishes (though aren't always proportionally calcuable)
Let's grab the Trawl ID's from these and then pull all of the associated trawls out into one table.

```{r}
#start with a subset for now
PlusCountTrawls<-merge(NoSL, SMFS_OTR_Thesis, by = c("TrawlRowID", "OrganismCode")) #merging the thesis data before adding zeros with the df I made of plus count fish to retain all records of relevant fish (organism code) from the same trawls as the plus counted fish.
n_distinct(PlusCountTrawls$TrawlRowID) #verifying that I still have the same number of trawls in consideration.
TrawlSum<-PlusCountTrawls %>% filter(!StandardLength.y==0) %>%  group_by(TrawlRowID, OrganismCode) %>% summarise(Total=sum(Count.y))
TrawlOver30<-TrawlSum %>% filter(Total>=30) #117 trawls have plus counted fish which we can estimate sizes for. The rest should be removed from the dataset since we don't know and can't guess their sizes.
```